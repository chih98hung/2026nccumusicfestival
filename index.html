<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風塵卜卜 - 命運測驗 (長按儲存最終修正)</title>
    <style>
        /* CSS 部分保持您修正長按的 pointer-events 設定，並將結果按鈕 z-index 提高 */
        html, body {
            height: 100%; 
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #0d1226; 
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            overflow: hidden; 
        }

        .quiz-container {
            width: 100%;
            max-width: 480px;
            max-height: 100vh;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: auto; 
        }

        #quiz-image {
            width: 100%;
            display: block;
            max-height: 100vh; 
            height: auto;
            /* 讓圖片成為最下層，確保可以長按 */
            z-index: 1; 
        }

        /* 按鈕容器：位於圖片上方的絕對定位層 */
        #button-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* 讓按鈕熱區層略高於圖片 */
            z-index: 5; 
            /* 讓非按鈕區域不接收點擊事件 */
            pointer-events: none; 
        }

        /* --- 最終版：通用隱藏按鈕樣式 --- */
        .option-button {
            position: absolute;
            background-color: transparent; 
            border: none;                  
            cursor: pointer;
            /* 確保按鈕熱區高於 button-area 和圖片 */
            z-index: 10; 
            
            color: transparent !important; 
            font-size: 0 !important;       
            line-height: 0 !important;     
            text-indent: -9999px;          
            overflow: hidden; 
            /* 重新啟用按鈕本身的點擊事件 */
            pointer-events: auto; 
        }
        
        /* 頁面特定按鈕的定位 (維持您提供的版本) */
        .start-cover-button {
            width: 60%; 
            left: 20%;  
            top: 25%;   
            height: 9%; 
        }

        .start-bottom-button {
            width: 50%; 
            left: 25%;  
            top: 80%; 
            height: 10%; 
        }

        .q-btn-a { top: 48%; left: 10%; width: 80%; height: 7%; }
        .q-btn-b { top: 58%; left: 10%; width: 80%; height: 7%; }
        .q-btn-c { top: 68%; left: 10%; width: 80%; height: 7%; }
        .q-btn-d { top: 78%; left: 10%; width: 80%; height: 7%; }

        /* 結果頁的三個底部按鈕 (維持在 quiz-container 內的絕對定位) */
        /* 注意：它們現在會直接附加到 quiz-container */
        .result-btn-share {
            top: 90%; 
            left: 8%; 
            width: 28%;
            height: 7%;
        }
        .result-btn-replay {
            top: 90%; 
            left: 36%; 
            width: 28%;
            height: 7%;
        }
        .result-btn-signup {
            top: 90%; 
            left: 64%; 
            width: 28%;
            height: 7%;
        }
    </style>
</head>
<body>

<div class="quiz-container">
    <img id="quiz-image" src="cover.png" alt="測驗封面">
    
    <div id="button-area">
        </div>
</div>

<script>
    // --- JavaScript 部分：修正 renderResultPage 函數邏輯 ---

    const LECTURE_URLS = {
        '捏捏': 'https://forms.gle/PvwhsYqJ7uAAqcrQ8',     
        '劉又熊': 'https://forms.gle/4C3PAuXNZKUm4CN98',   
        '林易祺': 'https://forms.gle/5SHN6fTp3p6397vs8'    
    };

    const PAGE_IMAGES = [
        'cover.png', 'intro.png', 'q1.png', 'q2.png', 'q3.png', 
        'q4.png', 'q5.png', 'q6.png', 'gotoresult.png'    
    ];
    
    const RESULT_DETAILS = {
        'R1': { file: 'result_star.png', lecture: '捏捏' },      
        'R2': { file: 'result_sun.png', lecture: '捏捏' },       
        'R3': { file: 'result_foggy.png', lecture: '劉又熊' },    
        'R4': { file: 'result_sunset.png', lecture: '劉又熊' },   
        'R5': { file: 'result_dawn.png', lecture: '林易祺' },     
        'R6': { file: 'result_moon.png', lecture: '林易祺' }      
    };

    let currentPage = 0; 
    let userAnswers = []; 
    let finalResultKey = '';

    const quizImage = document.getElementById('quiz-image');
    const buttonArea = document.getElementById('button-area');
    const quizContainer = document.querySelector('.quiz-container'); // 獲取主容器

    function preloadImages() {
        const imagesToPreload = [
            'intro.png', 'gotoresult.png', 
            'q1.png', 'q2.png', 'q3.png', 'q4.png', 'q5.png', 'q6.png', 
            'result_star.png', 'result_sun.png', 'result_foggy.png', 
            'result_sunset.png', 'result_dawn.png', 'result_moon.png' 
        ];
        imagesToPreload.forEach(src => {
            const img = new Image();
            img.src = src;
        });
    }
    preloadImages(); 

    function setPageImage(imageFileName) {
        quizImage.src = imageFileName;
        // 在非結果頁時，我們清空 buttonArea (包含結果按鈕)，並在 navigate 中重新繪製
        buttonArea.innerHTML = ''; 

        // **修正點：清理上一次結果頁可能直接添加到 quizContainer 的按鈕**
        document.querySelectorAll('.quiz-container > .option-button').forEach(btn => {
            btn.remove();
        });
    }

    function navigate(nextPage) {
        currentPage = nextPage;
        if (currentPage < PAGE_IMAGES.length) {
            setPageImage(PAGE_IMAGES[currentPage]);
            
            // 由於 result page 的按鈕是直接在 quizContainer 上，非 result page 的按鈕才需要在 buttonArea 上
            if (currentPage === 0) {
                renderStartButton(() => navigate(1), 'start-cover-button', buttonArea); 
            } else if (currentPage === 1) {
                renderStartButton(() => navigate(2), 'start-bottom-button', buttonArea); 
            } else if (currentPage >= 2 && currentPage <= 7) {
                renderQuizButtons(currentPage - 2, buttonArea); 
            } else if (currentPage === 8) {
                renderStartButton(calculateResult, 'start-bottom-button', buttonArea); 
            }
        } 
    }

    // 重新定義 renderStartButton 以便可以指定父元素
    function renderStartButton(callback, buttonClass, parentElement) {
        const button = document.createElement('button');
        button.className = `option-button ${buttonClass}`; 
        button.onclick = callback;
        parentElement.appendChild(button);
    }

    // 重新定義 renderQuizButtons 以便可以指定父元素
    function renderQuizButtons(questionIndex, parentElement) {
        const classes = ['q-btn-a', 'q-btn-b', 'q-btn-c', 'q-btn-d'];
        for (let i = 0; i < 4; i++) {
            const button = document.createElement('button');
            const answerValue = i + 1; 
            
            button.className = `option-button ${classes[i]}`;
            button.onclick = () => {
                userAnswers[questionIndex] = answerValue;
                if (questionIndex < 5) {
                    navigate(currentPage + 1);
                } else {
                    navigate(8); 
                }
            };
            parentElement.appendChild(button);
        }
    }

    function calculateResult() {
        const score = userAnswers.reduce((sum, current) => sum + current, 0);

        let resultKey;
        if (score <= 9) {
            resultKey = 'R1'; 
        } else if (score <= 12) {
            resultKey = 'R2'; 
        } else if (score <= 15) {
            resultKey = 'R3'; 
        } else if (score <= 18) {
            resultKey = 'R4'; 
        } else if (score <= 21) {
            resultKey = 'R5'; 
        } else {
            resultKey = 'R6'; 
        }
        
        finalResultKey = resultKey;
        renderResultPage();
    }

    // --- 關鍵修正處 ---
    function renderResultPage() {
        currentPage = 9; 
        const result = RESULT_DETAILS[finalResultKey];
        setPageImage(result.file); // 設置結果圖片，同時會清空 buttonArea 內容

        // **重要：將按鈕直接添加到 quizContainer，繞過 buttonArea 阻擋**
        // 1. 分享按鈕 (左)
        renderStartButton(() => {
            if (navigator.share) {
                navigator.share({
                    title: '風塵卜卜：我的命運結果',
                    text: '快來測測你的命運之聲！',
                    url: window.location.href, 
                }).catch(() => alert('分享失敗或已取消'));
            } else {
                alert('分享功能失效，請長按圖片手動截圖並分享！'); 
            }
        }, 'result-btn-share', quizContainer); // 直接加到 quizContainer

        // 2. 再玩一次按鈕 (中)
        renderStartButton(() => {
            userAnswers = []; 
            navigate(0); 
        }, 'result-btn-replay', quizContainer); // 直接加到 quizContainer

        // 3. 報名講座按鈕 (右)
        renderStartButton(() => {
            const lectureUrl = LECTURE_URLS[result.lecture];
            window.open(lectureUrl, '_blank'); 
        }, 'result-btn-signup', quizContainer); // 直接加到 quizContainer
        
        // **由於 buttonArea 已經被清空，且結果按鈕是直接加到 quizContainer，
        // 現在圖片上方應該沒有任何阻擋長按的透明層了。**
    }

    // --- 程式碼啟動點 ---
    navigate(0);

</script>

</body>
</html>
